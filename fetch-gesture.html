<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript">
      const fetchUrl = 'cgi-bin/delay.py?delay=500';

      function requestFullscreen() {
        const req = document.documentElement.requestFullscreen
            || document.documentElement.webkitRequestFullscreen
            || document.documentElement.mozRequestFullScreen;
        req.apply(document.documentElement);
      }

      function sleepThenFS(delay) {
        setTimeout(requestFullscreen, delay);
      }

      function sleepThenSleepThenFS(delay) {
        setTimeout(sleepThenFS.bind(this, delay), delay);
      }

      function fetchThenFS() {
        fetch(fetchUrl).then(requestFullscreen);
      }

      function xhrThenFS() {
        const client = new XMLHttpRequest();
        client.onload = requestFullscreen;
        client.open('GET', fetchUrl);
        client.send();
      }

      function crazyHackFetchThenFS() {
        let gotResult = false;
        const pendingTimeouts = [];
        let numPendingTimeouts = 0;
        // Launch 20 setTimeouts to wait for gotResult.
        for (let delay = 0; delay < 1000; delay += 50) {
          pendingTimeouts.push(setTimeout(() => {
            if (gotResult) {
              // Clear the remaining timeouts.
              for (const timeout of pendingTimeouts)
                clearTimeout(timeout);
              requestFullscreen();
            }
            numPendingTimeouts--;
          }, delay));
          numPendingTimeouts++;
        }
        // Perform a fetch and set gotResult when done.
        fetch(fetchUrl).then(() => {
          gotResult = true;
          // If there are no more timeouts after this, it's probably too late,
          // but just make the request anyway. This way it will either succeed,
          // or fail with an error message.
          if (numPendingTimeouts == 0)
            requestFullscreen();
        });
      }
    </script>
  </head>
  <body>
    <p>Open the console for logging.</p>
    <p>
      <input type="button" onclick="requestFullscreen()" value="Just Fullscreen" />
      <input type="button" onclick="sleepThenFS(0)" value="Sleep (0 s), then Fullscreen" />
      <input type="button" onclick="sleepThenFS(900)" value="Sleep (0.9 s), then Fullscreen" />
      <input type="button" onclick="sleepThenFS(5000)" value="Sleep (5 s), then Fullscreen" />
      <input type="button" onclick="sleepThenSleepThenFS(400)" value="Sleep (0.4 s) x2, then Fullscreen" />
      <input type="button" onclick="fetchThenFS()" value="Fetch, then Fullscreen" />
      <input type="button" onclick="xhrThenFS()" value="XHR, then Fullscreen" />
      <input type="button" onclick="crazyHackFetchThenFS()" value="Crazy hack fetch then Fullscreen" />
    </p>
    <p>Note: All of these "should" work, except "Sleep (5 s)" which might
    exceed the user agent's allowed time between gesture and request.</p>
  </body>
</html>

